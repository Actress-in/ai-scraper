# 📊 Googleスプレッドシート自動連携ガイド

**依頼が来たら自動でコード生成 → 実行 → 結果をスプレッドシートに保存**

---

## 🎯 自動化フロー

```
[Googleフォーム送信]
    ↓
[スプレッドシート記録]
    ↓ (自動トリガー)
[Google Apps Script実行]
    ↓ (Webhook送信)
[AI Scraper Backend]
    ├─ 1️⃣ ページ解析 (AI)
    ├─ 2️⃣ コード生成 (AI)
    ├─ 3️⃣ スクレイピング実行
    └─ 4️⃣ スクショ保存
    ↓
[結果をスプレッドシートに自動書き込み]
    ├─ ステータス: "完了" (緑色)
    ├─ 取得データ件数
    ├─ スクショURL
    └─ データファイルURL
```

---

## 📋 準備: スプレッドシートの構造

管理台帳シートに以下の列が必要です:

| 列 | 項目名 | 説明 |
|----|--------|------|
| A | 受付No | 自動採番 |
| B | タイムスタンプ | フォーム送信日時 |
| C | 依頼者 | 依頼者名 |
| D | 対象URL | スクレイピング対象のURL |
| E | 目的 | 依頼の目的 |
| F | ステータス | 新規受付/処理中/完了/エラー |
| G | 担当者 | 担当者名 |
| H | 希望納期 | 納期 |
| I | 取得件数 | 自動記入 ← **AIが記入** |
| J | スクショURL | 自動記入 ← **AIが記入** |
| K | データURL | 自動記入 ← **AIが記入** |
| L | 完了日時 | 自動記入 ← **AIが記入** |

---

## 🚀 セットアップ手順

### ステップ1: バックエンドのデプロイ

1. **Render.com**などにバックエンドをデプロイ
   ```bash
   cd backend
   npm install
   # Renderにデプロイ
   ```

2. デプロイ後のURL（例: `https://ai-scraper-xxxxx.onrender.com`）をメモ

### ステップ2: Google Apps Scriptの設定

1. スプレッドシートを開く

2. **拡張機能 > Apps Script** をクリック

3. `AutoScraper.gs`の内容を全てコピペ

4. **CONFIG.BACKEND_URL**を実際のURLに変更:
   ```javascript
   const CONFIG = {
     BACKEND_URL: 'https://ai-scraper-xxxxx.onrender.com', // ← ここを変更
     SHEET_NAME: '管理台帳',
     // ...
   };
   ```

5. **保存** (Ctrl+S / Cmd+S)

### ステップ3: トリガーの設定

#### 🔔 フォーム送信時の自動実行

1. Apps Script画面で **トリガー** アイコン (時計マーク) をクリック

2. **トリガーを追加** をクリック

3. 以下のように設定:
   - **実行する関数**: `onFormSubmit`
   - **イベントのソースを選択**: `スプレッドシートから`
   - **イベントの種類を選択**: `フォーム送信時`
   - **エラー通知設定**: `すぐに通知を受け取る`

4. **保存**

#### ⏰ 定期実行（オプション）

「新規受付」のものを5分おきに自動処理したい場合:

1. 再び **トリガーを追加**

2. 以下のように設定:
   - **実行する関数**: `processNewRequests`
   - **イベントのソースを選択**: `時間主導型`
   - **時間ベースのトリガーのタイプを選択**: `分ベースのタイマー`
   - **時間の間隔を選択**: `5分おき`

3. **保存**

### ステップ4: Google Sheets APIの有効化（書き込み機能を使う場合）

1. [Google Cloud Console](https://console.cloud.google.com/) にアクセス

2. プロジェクトを作成

3. **Google Sheets API** を有効化

4. サービスアカウントを作成してキーをダウンロード

5. キーファイルを `/backend/credentials/google-credentials.json` に配置

6. `.env`ファイルに追加:
   ```env
   GOOGLE_CREDENTIALS_PATH=./credentials/google-credentials.json
   ```

---

## 📱 使い方

### 方法1: フォーム送信で自動実行（完全自動）

1. 依頼者がGoogleフォームを送信
2. スプレッドシートに自動記録
3. **自動でスクレイピング開始** 🚀
4. 結果がスプレッドシートに自動記入される

### 方法2: 手動実行ボタン

1. スプレッドシートを開く
2. メニューに **🤖 AI Scraper** が表示される
3. **選択行を実行** をクリック
4. 実行したい行番号を入力
5. スクレイピング開始 🚀

### 方法3: ステータス変更で自動実行

1. 「新規受付」の行を手動で作成
2. 5分以内に自動実行される（定期トリガーを設定した場合）

---

## 🔧 トラブルシューティング

### ❌ Webhook送信エラー

**症状**: スプレッドシートのステータスが「エラー」になる

**確認項目**:
1. バックエンドがデプロイされているか確認
2. `CONFIG.BACKEND_URL`が正しいか確認
3. メニューの **🤖 AI Scraper > テスト実行** で接続確認

### ❌ スプレッドシートに結果が書き込まれない

**原因**: Google Sheets APIの認証が必要

**解決策**:
1. サービスアカウントを作成
2. スプレッドシートを共有（編集権限）
3. `GOOGLE_CREDENTIALS_PATH`を設定

### ❌ タイムアウトエラー

**原因**: スクレイピングに時間がかかりすぎている

**解決策**:
1. `.env`でタイムアウトを増やす:
   ```env
   DEFAULT_TIMEOUT=180000
   ```
2. Renderの有料プランに変更（無料プランは30秒制限）

---

## 📊 実行ログの確認

### Apps Scriptのログ

1. Apps Script画面で **実行数** をクリック
2. 実行履歴とエラーを確認

### バックエンドのログ

1. Renderのダッシュボードにアクセス
2. **Logs** タブを開く
3. リアルタイムログを確認

---

## 🎨 カスタマイズ

### 列のマッピングを変更

`AutoScraper.gs`の`CONFIG.COLUMNS`を編集:

```javascript
COLUMNS: {
  REQUEST_NO: 1,      // A列: 受付No
  TARGET_URL: 4,      // D列: 対象URL ← 列番号を変更
  STATUS: 6,          // F列: ステータス
  // ...
}
```

### ステータスの色を変更

バックエンド側の`backend/src/server.js`で色を変更:

```javascript
await sheetIntegration.updateRowColor(spreadsheetId, rowNumber, 'green');
// 'green' | 'yellow' | 'red'
```

---

## 🔐 セキュリティ

### APIキーの保護

- `.env`ファイルは絶対にコミットしない
- サービスアカウントキーは厳重に管理
- スプレッドシートの共有範囲を限定

### 実行権限

- トリガーは自分のアカウントで実行される
- 他のユーザーは実行履歴を見られない

---

## 💡 ベストプラクティス

1. **テスト環境を用意**: 本番シートとは別にテスト用シートを作成
2. **通知設定**: Apps Scriptのエラー通知を有効にする
3. **ログ監視**: 定期的にRenderのログを確認
4. **バックアップ**: スプレッドシートのバックアップを定期的に取る

---

## 📞 サポート

問題が発生した場合:

1. **設定を確認**: メニューの **🤖 AI Scraper > 設定を確認**
2. **接続テスト**: メニューの **🤖 AI Scraper > テスト実行**
3. **ログ確認**: Apps ScriptとRenderの両方のログを確認

---

🎉 **完全自動化の完成です!**

依頼が来たら、あとは何もしなくてOK。AI Scraperが自動で処理してくれます。
